<script src="https://vjs.zencdn.net/7.20.2/video.min.js"></script>
<link href="https://vjs.zencdn.net/7.20.2/video-js.css" rel="stylesheet" />
<script src="https://unpkg.com/turndown/dist/turndown.js"></script>
<style>
    @media (max-width: 1100px) {
        .vjs-remaining-time {
            display: none;
        }

        .for-pc {
            display: none;
        }
    }
    .timestamp-list {
        display: flex;
        overflow-x: auto; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
        white-space: nowrap;
        flex-direction: column;
        list-style: none;
        padding: 0;
        position: relative; /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ç·šã‚’é…ç½®ã™ã‚‹ãŸã‚ */
        /* margin-left: 20px; */
    }

    .timestamp-list::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #ccc; /* ç·šã®è‰² */
    }

    .timestamp-list li {
        /* flex: 1 1 20%; */
        box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¨ãƒœãƒ¼ãƒ€ãƒ¼ã‚’å«ã‚ãŸå¹…ã‚’è¨ˆç®— */
        position: relative;
        margin-bottom: 10px;
        /* padding-left: 20px; */
    }

    .timestamp-list li::before {
        content: '';
        position: absolute;
        left: -10px;
        top: 5px;
        width: 10px;
        height: 10px;
        /* background: #fff;
        border: 2px solid #343a40;
        border-radius: 50%; */
    }

    .timestamp-link {
        text-decoration: none;
        color: #343a40;
        display: flex;
        flex-direction: column; /* ç¸¦æ–¹å‘ã«é…ç½® */
        align-items: flex-start; /* å·¦æƒãˆ */
        width: 100%; /* å¹…ã‚’å‡ç­‰ã«ã™ã‚‹ */
    }

    .timestamp-card {
        margin-right: 10px;
    }

    .timestamp-time {
        font-weight: bold;
        margin-top: 5px; /* èª¬æ˜ã¨æ™‚é–“ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ  */
    }

    .timestamp-description {
        flex-grow: 1;
    }

    @media (min-width: 1101px) {
        .container-wrapper {
            display: flex; /* æ¨ªä¸¦ã³ã«ã™ã‚‹ */
        }

        #container {
            flex: 1; /* containerã‚’å·¦ã«è¡¨ç¤º */
        }

        .timestamp-list {
            width: 400px; /* timestamp-listã®å¹…ã‚’è¨­å®š */
        }

        .for-mobile {
            display: none;
        }
    }
</style>
<%= form_with model: @note, local: true, html: {class: "needs-validation", novalidate: true, params: { group_id: params[:group_id] } } do |form| %>
    <% if @note.errors.any? %>
        <div id="error_explanation">
            <h2><%= pluralize(@note.errors.count, "error") %> prohibited this note from being saved:</h2>
            <ul>
                <% @note.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                <% end %>
            </ul>
        </div>
    <% end %>
    <div class="container-wrapper">
        <div id = "container" class="px-3 mt-3">
            <% video = nil %>
            <% if @with_video == "true" && @video_id %>
                <% video = Video.find_by(id: @video_id)%>
                <video class="video-js vjs-big-play-centered" preload="metadata" controls playsinline id="video" data-video-id="<%= @video_id%>">
                    <source src="<%= rails_blob_path(video.video) %>" type="video/mp4">
                </video>

                <div class="h3" style="margin-top: 40px; margin-bottom: 50px; font-weight: 700;">
                    <%= video.title %>  : ãƒãƒ¼ãƒˆã®ä½œæˆ
                </div>

                <!-- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒªã‚¹ãƒˆ -->
                <div id="timestamp-list" class="for-mobile" style="margin-top: 10px;">
                    <div class="d-flex justify-content-between align-items-center" style="margin-right: 10px;">
                    <h5 style="margin-bottom: 20px;">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h5>
                    <%# <button class="modal-open btn btn-dark d-block rounded-circle bg-black" style="margin-bottom: 20px;">
                        <i class="fas fa-plus"></i>
                    </button> %>
                    </div>

                    <ul class="timestamp-list" style="max-height: 450px; overflow-y">
                    <% video.timestamps.order(time_s: :asc).each do |timestamp| %>
                        <li>
                        <div class="card timestamp-card">
                            <div class="card-body">
                            <div class="d-flex align-items-center">
                                <a href="#" class="timestamp-link" data-turbo="false" onclick="jumpTo(<%= timestamp.time_s %>)">
                                    <span class="timestamp-description"><%= timestamp.description %></span>
                                    <span class="timestamp-time"><%= "#{(timestamp.time_s / 60).to_i}:#{(timestamp.time_s % 60).to_i}" %></span>
                                </a>
                            </div>
                            </div>
                        </div>
                        </li>
                    <% end %>
                    </ul>
                    <hr style="border-top: 1px solid grey; width: 100%; margin-top: 20px; margin-bottom: 20px;">
                </div>
            <% else %>
                <div class="h3" style="margin-top: 40px; margin-bottom: 50px; font-weight: 700;">
                    ãƒãƒ¼ãƒˆã®ä½œæˆ
                </div>
            <% end %>

            <!-- å‰å›ã®ãƒãƒ¼ãƒˆã‚’å–å¾—ï¼ˆè©¦åˆãªã‚‰è©¦åˆã€ç·´ç¿’ãªã‚‰ç·´ç¿’ã®ãƒãƒ¼ãƒˆï¼‰ -->
            <% if params[:note_for] == "practice" %>
                <% latest_note = Note.where(user_id: current_user.id, group_id: params[:group_id], note_for: "practice").order(created_at: :desc).first %>
            <% else %>
                <% latest_note = Note.where(user_id: current_user.id, group_id: params[:group_id], note_for: "match").order(created_at: :desc)[1] %>
            <% end %>

            <style>
            .previous-note {
                background-color: #f8f9fa;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                padding: 20px;
                margin-bottom: 30px;
            }
            .previous-note-header {
                color: #343a40;
                font-size: 1.5rem;
                margin-bottom: 15px;
                border-bottom: 2px solid #007bff;
                padding-bottom: 10px;
            }
            .previous-note h4 {
                color: #495057;
                font-size: 1.2rem;
                margin-top: 20px;
                margin-bottom: 10px;
            }
            .previous-note p {
                color: #6c757d;
                line-height: 1.6;
            }
            .note-date {
                font-size: 0.9rem;
                color: #6c757d;
            }
            .note-section {
                margin-bottom: 20px;
            }
            /* ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆå†…ã®ç”»åƒã‚’è‡ªå‹•ãƒªã‚µã‚¤ã‚º */
            .note-content img {
                max-width: 100%;
                height: auto;
            }
            </style>

            <div class="previous-note">
                <% if latest_note %>
                    <div class="previous-note-header d-flex justify-content-between align-items-center mb-3">
                        <h3 class="mb-0">å‰å›ã®ãƒãƒ¼ãƒˆ</h3>
                        <div class="note-date text-muted"><%= latest_note.created_at.strftime('%Yå¹´%mæœˆ%dæ—¥') %></div>
                    </div>
                    <h5><%= latest_note.title %></h5>
                    
                    <div class="note-section">
                        <h4>Good</h4>
                        <div class="note-content"><%= safe_join([latest_note.good.html_safe]) %></div>
                    </div>
                    
                    <div class="note-section">
                        <h4>Bad</h4>
                        <div class="note-content"><%= safe_join([latest_note.bad.html_safe]) %></div>
                    </div>
                    
                    <div class="note-section">
                        <h4>Next</h4>
                        <div class="note-content"><%= safe_join([latest_note.next.html_safe]) %></div>
                    </div>
                    
                    <% if latest_note.discuss %>
                        <div class="note-section">
                            <h4>ãƒãƒ¼ãƒ ã§ç¢ºèªã—ãŸã„ã“ã¨:</h4>
                            <div class="note-content"><%= safe_join([latest_note.discuss.html_safe]) %></div>
                        </div>
                    <% end %>
                <% else %>
                    <p>å‰å›ã®ãƒãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <% end %>
            </div>


            <!--
            <script src="https://cdn.tailwindcss.com"></script>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
            <div class="flex items-center justify-center" style="margin-top: 30px; margin-bottom: 30px;">
                <div class="bg-white rounded-lg shadow-lg p-6 w-full lg:w-3/4">
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-gray-400 text-lg">Add a titleâ€”what are you aligning on?</h1>
                        <span class="text-gray-400">æ‰æ‘å®Ÿç´€ voted</span>
                    </div>
                    <div class="relative mb-4">
                        <div class="h-2 bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full"></div>
                        <div class="absolute inset-0 flex justify-between items-center px-4">
                            <div class="h-6 w-1 bg-red-500 rounded-full" style="position: absolute; left: 0;"></div>
                            <div class="h-6 w-1 bg-gradient-to-r from-red-500 to-yellow-500 rounded-full" style="position: absolute; left: 25%;"></div>
                            <div class="h-6 w-1 bg-yellow-500 rounded-full" style="position: absolute; left: 50%;"></div>
                            <div class="h-6 w-1 bg-gradient-to-r from-yellow-500 to-green-500 rounded-full" style="position: absolute; left: 75%;"></div>
                            <div class="h-6 w-1 bg-green-500 rounded-full" style="position: absolute; right: 0;"></div>
                        </div>
                        <div class="absolute inset-0 flex justify-center items-center">
                            <div class="bg-green-800 text-white rounded-full h-8 w-8 flex items-center justify-center text-sm">å®Ÿç´€</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-red-500 w-1/4 text-center">Strongly<br>disagree</span>
                        <span class="text-yellow-500 w-1/2 text-center">Neutral</span>
                        <span class="text-green-500 w-1/4 text-center">Strongly<br>agree</span>
                    </div>
                    <%# <div class="flex justify-center">
                        <button class="bg-purple-500 text-white py-2 px-4 rounded-full flex items-center">
                            <i class="fas fa-eye mr-2"></i> Results revealed
                        </button>
                    </div> %>
                </div>
            </div>
            -->

            <!-- ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="form-group">
                <label id="title" for="note_title" class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
                <% if params[:note_for] == "practice" %>
                    <%= form.text_field :title, class: 'form-control mb-3', id: 'note_title', value: "[#{Date.today}] ç·´ç¿’ã®æŒ¯ã‚Šè¿”ã‚Š", placeholder: "ä¾‹ï¼šã€Œ#{Date.today}ã®æŒ¯ã‚Šè¿”ã‚Šã€)", style: "padding: 10px;" %>
                <% elsif video %>
                    <%= form.text_field :title, class: 'form-control mb-3', id: 'note_title', value: "#{video.title}ã®æŒ¯ã‚Šè¿”ã‚Š", style: "padding: 10px;" %>
                <% else %>
                    <%= form.text_field :title, class: 'form-control mb-3', id: 'note_title', value: "[#{Date.today}] è©¦åˆã®æŒ¯ã‚Šè¿”ã‚Š", style: "padding: 10px;" %>
                <% end %>
            </div>


            <!-- ä¸Šæ‰‹ãã„ã£ãŸç‚¹ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="form-group" id="good" data-note-for="<%= @note_for %>" data-user-id="<%= current_user.id %>" data-token="<%= @unique_token %>" data-group-id="<%= params[:group_id]%>">
                <label class="form-label">ä¸Šæ‰‹ãã„ã£ãŸã“ã¨</label>
                <% if @with_video == "true" %>
                    <% placeholder_text = 'ä¸Šæ‰‹ãã„ã£ãŸã“ã¨ã‚’è¨˜å…¥ (ğŸ•“ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã—ã¦ã€å‹•ç”»ã®ç¾åœ¨ã®æ™‚é–“ã‚’å…¥åŠ›ã§ãã¾ã™ã€‚)' %>
                <% else %>
                    <% placeholder_text = 'ä¸Šæ‰‹ãã„ã£ãŸã“ã¨ã‚’è¨˜å…¥' %>
                <% end %>
                <%= form.rich_text_area :good, class: 'form-control mb-3', id: 'note_good', "data-controller": "diff-content", placeholder: placeholder_text, style: "padding: 10px; max-height: 1200px; height: 100px;" %>
            </div>
            <div id="notes_good_rate">
            </div><br />

            <div id="notes_good">
                <!-- ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div><br />
            <%= turbo_stream_from "rate_user_#{session.id}" %>
            <%= turbo_stream_from "user_#{session.id}" %>
            <%= turbo_stream_from "spinner" %>
            <div id="spinner_good"></div>
            
            <!-- ä¸Šæ‰‹ãã„ã‹ãªã‹ã£ãŸç‚¹ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="form-group" id="bad">
                <label class="form-label">ä¸Šæ‰‹ãã„ã‹ãªã‹ã£ãŸã“ã¨</label>
                <% if @with_video == "true" %>
                    <% placeholder_text = 'ä¸Šæ‰‹ãã„ã‹ãªã‹ã£ãŸã“ã¨ã‚’è¨˜å…¥ (ğŸ•“ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã—ã¦ã€å‹•ç”»ã®ç¾åœ¨ã®æ™‚é–“ã‚’å…¥åŠ›ã§ãã¾ã™ã€‚)' %>
                <% else %>
                    <% placeholder_text = 'ä¸Šæ‰‹ãã„ã‹ãªã‹ã£ãŸã“ã¨ã‚’è¨˜å…¥' %>
                <% end %>
                <%= form.rich_text_area :bad, class: 'form-control mb-3', id: 'note_bad', placeholder: placeholder_text, style: "padding: 10px; max-height: 1200px; height: 100px;" %>
            </div>
            <div id="notes_bad_rate">
            </div><br />
            <div id="notes_bad">
                <!-- ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div><br />
            <div id="spinner_bad"></div>

            <!-- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="form-group" id="next">
                <label class="form-label">æ¬¡ã«æ„è­˜ã™ã‚‹ã“ã¨ãƒ»æ¬¡ã«å‘ã‘ã¦å–ã‚Šçµ„ã‚€ã“ã¨</label>
                <% if @with_video == "true" %>
                    <% placeholder_text = 'æ¬¡ã«å‘ã‘ã¦å–ã‚Šçµ„ã‚€ã“ã¨ã‚’è¨˜å…¥ (ğŸ•“ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã—ã¦ã€å‹•ç”»ã®ç¾åœ¨ã®æ™‚é–“ã‚’å…¥åŠ›ã§ãã¾ã™ã€‚)' %>
                <% else %>
                    <% placeholder_text = 'æ¬¡ã«å‘ã‘ã¦å–ã‚Šçµ„ã‚€ã“ã¨ã‚’è¨˜å…¥' %>
                <% end %>
                <%= form.rich_text_area :next, class: 'form-control mb-3', id: 'note_next', placeholder: placeholder_text, style: "padding: 10px; max-height: 1200px; height: 100px;" %>
                <div id="links">

                </div>
            </div>
            <div id="notes_next_rate">
            </div><br />
            <div id="notes_next">
                <!-- ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div><br />
            <div id="spinner_next"></div>

            <!-- è©±ã—åˆã„ãŸã„ã“ã¨ãƒ»ç¢ºèªã—ãŸã„ã“ã¨ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="form-group" id="discuss">
                <label  class="form-label">ãƒãƒ¼ãƒ ã§è©±ã—åˆã„ãŸã„ã“ã¨ãƒ»ç¢ºèªã—ãŸã„ã“ã¨</label>
                <% if params[:note_for] == "practice" %>
                    <%= form.rich_text_area :discuss, id: 'note_discuss', placeholder: 'ãƒãƒ¼ãƒ ã§è©±ã—åˆã„ãŸã„ã“ã¨ãƒ»ç¢ºèªã—ãŸã„ã“ã¨(ä¾‹ï¼šç·´ç¿’æ™‚é–“ãŒé•·ã„)
                    @someoneã®ã‚ˆã†ã«ã—ã¦ãƒãƒ¼ãƒ ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ãã¾ã™ã€‚', style: "height: 100px;", data: { controller: "mentions", mentions_target: "field" } %>
                <% else %>
                    <%= form.rich_text_area :discuss, id: 'note_discuss', placeholder: 'ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãªã©ã§ãƒãƒ¼ãƒ ã§è©±ã—åˆã„ãŸã„ã“ã¨ãƒ»ç¢ºèªã—ãŸã„ã“ã¨
                    @someoneã®ã‚ˆã†ã«ã—ã¦ãƒãƒ¼ãƒ ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ãã¾ã™ã€‚', style: "height: 100px;", data: { controller: "mentions", mentions_target: "field" } %>
                <% end %>

                <div id="links">

                </div>
            </div>
            <div id="notes_discuss">
                <!-- ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div><br />
            <div id="spinner_discuss"></div>

            <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
            <div class="form-group">
                <%= form.button "ä½œæˆ", type: 'submit', "data-turbo": false, class: 'btn btn-outline-primary', style: "border-radius: 1;" %>
            </div>
            <br />
        </div>
        <% if !request.env['HTTP_USER_AGENT'].include?('Mobile') && video %>
            <!-- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒªã‚¹ãƒˆ -->
            <div id="timestamp-list" class="for-pc mt-3" style="margin-top: 10px;">
            <div class="d-flex justify-content-between align-items-center" style="margin-right: 10px;">
                <h5 style="margin-bottom: 20px;">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h5>
                <%# <button class="modal-open btn btn-dark d-block rounded-circle bg-black" style="margin-bottom: 20px;">
                    <i class="fas fa-plus"></i>
                </button> %>
            </div>

            <ul class="timestamp-list">
                <% video.timestamps.order(time_s: :asc).each do |timestamp| %>
                <li>
                    <div class="card timestamp-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                        <a href="#" id = "timestamp-link" class="timestamp-link" data-turbo="false" onclick="jumpTo(<%= timestamp.time_s %>)">
                            <span class="timestamp-description"><%= timestamp.description %></span>
                            <span class="timestamp-time"><%= "#{(timestamp.time_s / 60).to_i}:#{(timestamp.time_s % 60).to_i}" %></span>
                        </a>
                        </div>
                    </div>
                    </div>
                </li>
                <% end %>
            </ul>
            <%# <hr style="border-top: 1px solid grey; width: 100%; margin-top: 20px; margin-bottom: 20px;"> %>
            </div>
        <% end %>
    </div>
<% end %>

<script>
    $(function(){
        var loc=false;
        $(window).bind("beforeunload", function(e) {
            // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã›ãŸã„æ–‡å­—åˆ—
            if (!loc) {
                return "å…¥åŠ›ã¯å®Œäº†ã—ã¦ã„ã¾ã›ã‚“ï½¡";
            }
        });
        // aãƒªãƒ³ã‚¯ã‚’é·ç§»OKã«ã™ã‚‹å ´åˆã¯ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã™
        $('a').click( function() {loc=true;});
        $("button").submit(function(){loc=true;});
    });

    // Turndown ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
    const turndownService = new TurndownService();

    var $input_good = $('#note_good');
    // trixã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³ã—ã¦suggestion-changedã‚’åˆæœŸåŒ–
    $input_good.on('trix-initialize', function() {
        $(this).data('suggestion-changed', false);
    });

    // æ‰‹å‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æ¤œå‡ºã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
    var isManualFocus_Good = false;

    // ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³ã¾ãŸã¯ã‚¿ãƒƒãƒã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
    $input_good.on('mousedown touchstart', function() {
        isManualFocus_Good = true;
    });

    $input_good.on('trix-focus', function() {
        if (isManualFocus_Good) {
            console.log("focus...");
            $input_good.find('*').removeClass();
            $input_good.data('suggestion-changed', false);
        }
    });

    // ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã•ã‚Œã€ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãŒãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰å¤–ã‚ŒãŸæ™‚ã«ç™ºç«ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
    $input_good.on('trix-change', function(event) {
        // HTML ã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã«å¤‰æ›
        const markdown = turndownService.turndown(event.target.innerHTML);
        // console.log("changed...");
        // å¤‰æ›´ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
        $('#note_good').data('changed', true);
    });

    $input_good.on('trix-blur', function() {
        isManualFocus = false;
        $input_good = $('#note_good');
        console.log("changed: ", $input_good.data('changed'));
        console.log("suggestion-changed: ", $input_good.data('suggestion-changed'));
        if ($input_good.data('changed')) {
            if ($input_good.data('suggestion-changed') === false) {
                const markdown = turndownService.turndown(this.innerHTML);
                
                fetch('/notes/gpt_api_request_good', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’metaã‚¿ã‚°ã‹ã‚‰å–å¾—ã—ã¦è¨­å®š
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    },
                    body: JSON.stringify({data: { value: markdown, user_id: parseInt(document.getElementById("good").getAttribute("data-user-id")), token: document.getElementById("good").getAttribute("data-token"), group_id: parseInt(document.getElementById("good").getAttribute("data-group-id")), note_for: document.getElementById("good").getAttribute("data-note-for") }})
                }).then(response => {
                    if (response.ok) {
                        $('#note_good').data('changed', false);
                    }
                }).catch(error => {
                    console.error('Error:', error);
                });
            } else {
                $('#note_good').data('changed', false);
            }
            
        }
    });

    var $input_bad = $('#note_bad');
    // trixã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³ã—ã¦suggestion-changedã‚’åˆæœŸåŒ–
    $input_bad.on('trix-initialize', function() {
        $(this).data('suggestion-changed', false);
    });

    // æ‰‹å‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æ¤œå‡ºã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
    var isManualFocus_Bad = false;

    // ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³ã¾ãŸã¯ã‚¿ãƒƒãƒã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
    $input_bad.on('mousedown touchstart', function() {
        isManualFocus_Bad = true;
    });

    $input_bad.on('trix-focus', function() {
        if (isManualFocus_Bad) {
            console.log("focus...");
            $input_bad.find('*').removeClass();
            $input_bad.data('suggestion-changed', false);
        }
    });

    $input_bad.on('trix-change', function(event) {
        // HTML ã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã«å¤‰æ›
        const markdown = turndownService.turndown(event.target.innerHTML);
        // å¤‰æ›´ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
        $input_bad.data('changed', true);
        console.log("changed....");
    });
    // ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã•ã‚Œã€ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãŒãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰å¤–ã‚ŒãŸæ™‚ã«ç™ºç«ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
    $input_bad.on('trix-blur', function(event) {
        if ($input_bad.data('changed')) {
            console.log("We'll request api...")
            // HTML ã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã«å¤‰æ›
            const markdown = turndownService.turndown(event.target.innerHTML);
            
            fetch('/notes/gpt_api_request_bad', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’metaã‚¿ã‚°ã‹ã‚‰å–å¾—ã—ã¦è¨­å®š
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({data: { value: markdown, user_id: parseInt(document.getElementById("good").getAttribute("data-user-id")), token: document.getElementById("good").getAttribute("data-token"), group_id: parseInt(document.getElementById("good").getAttribute("data-group-id")), note_for: document.getElementById("good").getAttribute("data-note-for") }})
            });
        }
    });

    var $input_next = $('#note_next');
    $input_next.on('trix-change', function(event) {
        // HTML ã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã«å¤‰æ›
        const markdown = turndownService.turndown(event.target.innerHTML);
        // å¤‰æ›´ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
        $input_next.data('changed', true);
        console.log("changed....");
    });
    // ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã•ã‚Œã€ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãŒãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰å¤–ã‚ŒãŸæ™‚ã«ç™ºç«ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
    $input_next.on('trix-blur', function(event) {
        if ($input_next.data('changed')) {
            console.log("We'll request api...")
            // HTML ã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã«å¤‰æ›
            const markdown = turndownService.turndown(event.target.innerHTML);
            
            fetch('/notes/gpt_api_request_next', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’metaã‚¿ã‚°ã‹ã‚‰å–å¾—ã—ã¦è¨­å®š
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({data: { value: markdown, user_id: parseInt(document.getElementById("good").getAttribute("data-user-id")), token: document.getElementById("good").getAttribute("data-token"), group_id: parseInt(document.getElementById("good").getAttribute("data-group-id")), note_for: document.getElementById("good").getAttribute("data-note-for") }})
            });
        }
    });

    function replaceWith(type, suggestion_title) {
        console.log("type: ", type);
        // é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’å–å¾—
        const selectedRadio = document.querySelector('input[name="custom-radio"]:checked');
        if (selectedRadio) {
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®è¦ªè¦ç´ ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
            const selectedText = selectedRadio.parentElement.textContent.trim();
            console.log(selectedText);
            console.log(`${type}`);
            const trix_editor = document.getElementById(`${type}`).editor;
            const documentText = trix_editor.getDocument().toString();
            const index = documentText.indexOf(suggestion_title);
            if (index != -1) {
                trix_editor.setSelectedRange([index, suggestion_title.length])
                trix_editor.deleteInDirection("forward")
            }
            trix_editor.insertHTML(`<span class='highlight-green'>${selectedText}</span>`);
        } else {
            alert('ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        }
    }
</script>

<% if @with_video && @video_id %>
    <script>
        const player = videojs('video', {
            autoplay: false, // è‡ªå‹•å†ç”Ÿã‚’ç„¡åŠ¹
            fluid: true, // å‹•ç”»ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¦ªè¦ç´ ã„ã£ã±ã„ã«åºƒã’ã‚‹
            loop: false, // ç¹°ã‚Šè¿”ã—å†ç”Ÿç„¡åŠ¹
            controls: true, // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©è¡¨ç¤º
            playbackRates: [0.5, 1, 1.3, 1.5], // å†ç”Ÿé€Ÿåº¦ã®å€ç‡
            controlBar: {
                pictureInPictureToggle: false, // ãƒ”ã‚¯ãƒãƒ£ãƒ¼ã‚¤ãƒ³ãƒ”ã‚¯ãƒãƒ£ãƒ¼ã‚’ç„¡åŠ¹ã«ã™ã‚‹
                fullscreenToggle: true, // å…¨ç”»é¢ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                volumePanel: false // éŸ³å£°ãƒãƒ¼ã‚’ç„¡åŠ¹ã«ã™ã‚‹

            }
        });
        var video_el = document.getElementById("video");

        // videojsã®readyã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã¨ãã®å‡¦ç†ã‚’è¨­å®š
        player.ready(function() {
            var self = this;
            self.on('loadedmetadata', () => {
            console.log('loaded meta data.');
            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«10ç§’æˆ»ã—ãƒœã‚¿ãƒ³ã¨10ç§’é€ã‚Šãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const rewindButton = player.getChild('ControlBar').addChild('button');
            const forwardButton = player.getChild('ControlBar').addChild('button');
            rewindButton.controlText('10ç§’æˆ»ã—');
            forwardButton.controlText('10ç§’ã‚Š');

            rewindButton.el().style.marginRight = '-6px';
            forwardButton.el().style.marginLeft = '-6px';

            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
            const controlBar = player.getChild('ControlBar');
            const fullscreenToggle = controlBar.getChild('fullscreenToggle');

            // æŒ¿å…¥ä½ç½®ã‚’æ±ºå®šï¼ˆPiPãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å…¨ç”»é¢ãƒœã‚¿ãƒ³ã®å‰ã«æŒ¿å…¥ï¼‰
            const insertBeforeElement = fullscreenToggle;

            if (insertBeforeElement) {
                controlBar.el().insertBefore(
                rewindButton.el(),
                insertBeforeElement.el()
                ).innerHTML = `<img src="<%= asset_path 'rewind.png' %>" width="20" />`;
                
                controlBar.el().insertBefore(
                forwardButton.el(),
                insertBeforeElement.el()
                ).innerHTML = `<img src="<%= asset_path 'forward.png' %>" width="20" />`;
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æŒ¿å…¥ä½ç½®ï¼ˆæœ€å¾Œï¼‰ã«è¿½åŠ 
                controlBar.el().appendChild(rewindButton.el()).innerHTML = `<img src="<%= asset_path 'rewind.png' %>" width="20" />`;
                controlBar.el().appendChild(forwardButton.el()).innerHTML = `<img src="<%= asset_path 'forward.png' %>" width="20" />`;
            }

            // ã‚¹ã‚­ãƒƒãƒ—å‡¦ç†ã‚’è¿½åŠ 
            rewindButton.el().addEventListener('click', () => {
                var newTime = self.currentTime() - 10;
                if (newTime < 0) newTime = 0; // ç¾åœ¨æ™‚åˆ»ãŒ0æœªæº€ã«ãªã‚‰ãªã„ã‚ˆã†ã«èª¿æ•´
                self.currentTime(newTime);
            });
            
            forwardButton.el().addEventListener('click', () => {
                var newTime = self.currentTime() + 10;
                var maxTime = self.duration(); // ãƒ“ãƒ‡ã‚ªã®é•·ã•ã‚’å–å¾—
                if (newTime > maxTime) newTime = maxTime; // ç¾åœ¨æ™‚åˆ»ãŒãƒ“ãƒ‡ã‚ªã®é•·ã•ä»¥ä¸Šã«ãªã‚‰ãªã„ã‚ˆã†ã«èª¿æ•´
                self.currentTime(newTime);
            });

            document.addEventListener('keydown', function (e) {
                if (e.code == 'ArrowLeft') {
                var newTime = self.currentTime() - 10;
                if (newTime < 0) newTime = 0; // ç¾åœ¨æ™‚åˆ»ãŒ0æœªæº€ã«ãªã‚‰ãªã„ã‚ˆã†ã«èª¿
                self.currentTime(newTime);
                } else if (e.code == 'ArrowRight') {
                var newTime = self.currentTime() + 10;
                var maxTime = self.duration(); // ãƒ“ãƒ‡ã‚ªã®é•·ã•ã‚’å–å¾—
                if (newTime > maxTime) newTime = maxTime; // ç¾åœ¨æ™‚åˆ»ãŒãƒ“ãƒ‡ã‚ªã®é•·ã•ä»¥ä¸Šã«ãªã‚‰ãªã„ã‚ˆã†ã«èª¿æ•´
                self.currentTime(newTime);
                }
            })
            });
        });

        function jumpTo(time) {
            player.currentTime(time);
        }

        document.addEventListener("trix-initialize", function(event) {
            const buttonHTML = '<button type="button" class="trix-button" onclick="insertCurrentTime(this.closest(\'.form-group\').id);" title="å‹•ç”»ã®ç¾åœ¨ã®æ™‚é–“ã‚’æŒ¿å…¥ã§ãã¾ã™ã€‚" tabindex="-1" style="font-size: 100%; width: 3.0em;"><i class="fas fa-clock" style="color: black;"></i></button>';
            event.target.toolbarElement.querySelector(".trix-button-group--file-tools").insertAdjacentHTML("beforeend", buttonHTML);
        });

        function insertCurrentTime(section) {
            const player = videojs('video');
            const currentTime = player.currentTime();
            const minutes = Math.floor(currentTime / 60);
            const seconds = Math.floor(currentTime % 60);
            const timeString = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            const goodField = document.getElementById('note_good');
            const badField = document.getElementById('note_bad');
            const nextField = document.getElementById('note_next');
            const discussField = document.getElementById('note_discuss');
            let field;
            switch (section) {
                case "good":
                    field = goodField;
                    break;
                case "bad":
                    field = badField;
                    break;
                case "next":
                    field = nextField;
                    break;
                case "discuss":
                    field = discussField;
                    break;
                default:
                    field = discussField;
            }
            const trixEditor = field.editor;
            trixEditor.insertString(` ${timeString}`);
        }
    </script>
<% end %>